<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="q view">
  <title>q view</title>
  <link rel="stylesheet" type="text/css" href="{assets}/css/{cssTheme}.css">
  <link rel="stylesheet" type="text/css" href="{assets}/css/q-view.css">
  <script type="text/javascript" src="{assets}/js/perspective.inline.js"></script>
  <script type="text/javascript" src="{assets}/js/perspective-viewer.js"></script>
  <script type="text/javascript" src="{assets}/js/perspective-viewer-datagrid.js"></script>
  <script type="text/javascript" src="{assets}/js/perspective-viewer-d3fc.js"></script>
</head>

<body>
  <div id="toolbar">
    <div id="toolbar-left">
      <!--<a id="buy-coffee" title="buy me a coffee" href="#" style="color: orangered; font-weight: bold"
        onclick="buyCoffee()">buy me a coffee</a> -->
      <select id="save-file-type-selector" title="save data as" onChange="saveData()">
        <option value="">Save as</option>
        <option value=".csv">csv</option>
        <option value=".xlsx">xlsx</option>
      </select>
    </div>
    <div id="toolbar-right">
      <input id="data-view-stats" type="text" readonly="readonly" title="data stats" />
    </div>
  </div>
  <perspective-viewer id="data-viewer" class="perspective-viewer-material{theme}" editable="true"
    style="--select--background-color: var(--vscode-editor-background)"></perspective-viewer>
  <script type="text/javascript" charset="utf-8">
    let vscode, saveFileTypeSelector, viewer, msg, isReady = false;
    let keyColor = '{keyColor}';
    const overridden_types = {
      types: {
        float: {
          filter_operator: '==',
          aggregate: 'sum',
          format: {
            style: 'decimal',
            minimumFractionDigits: 2,
            maximumFractionDigits: 7
          }
        },
        string: {
          filter_operator: '==',
          aggregate: 'count'
        },
        integer: {
          filter_operator: '==',
          aggregate: 'sum',
          format: {}
        },
        boolean: {
          filter_operator: '==',
          aggregate: 'count'
        },
        datetime: {
          filter_operator: '==',
          aggregate: 'count',
          format: {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            fractionalSecondDigits: 3,
            hourCycle: 'h23',
          },
        },
        timestamp: {
          filter_operator: '==',
          aggregate: 'count',
          type: 'datetime',
          format: {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            fractionalSecondDigits: 3,
            hourCycle: 'h23',
          },
        },
        time: {
          filter_operator: '==',
          aggregate: 'count',
          type: 'datetime',
          format: {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            fractionalSecondDigits: 3,
            hourCycle: 'h23',
          },
          null_value: -1
        },
        timespan: {
          filter_operator: '==',
          aggregate: 'count',
          type: 'datetime',
          format: {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            fractionalSecondDigits: 3,
            hourCycle: 'h23',
          },
          null_value: -1
        },
        minute: {
          filter_operator: '==',
          aggregate: 'count',
          type: 'datetime',
          format: {
            hour: '2-digit',
            minute: '2-digit',
            hourCycle: 'h23',
          },
          null_value: -1
        },
        second: {
          filter_operator: '==',
          aggregate: 'count',
          type: 'datetime',
          format: {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hourCycle: 'h23',
          },
          null_value: -1
        },
        date: {
          filter_operator: '==',
          aggregate: 'count',
          format: {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
          },
          null_value: -1
        },
        month: {
          filter_operator: '==',
          aggregate: 'count',
          type: 'date',
          format: {
            year: 'numeric',
            month: '2-digit',
          },
          null_value: -1
        }
      }
    };

    const worker = perspective.worker(overridden_types);

    // get api to interact with vscode
    vscode = acquireVsCodeApi();

    // add vscode message handler
    window.addEventListener('message', event => {
      const message = event.data;
      console.log(`got a vscode message, type: ${message.type}`);
      switch (message.type) {
        // raw byte array
        case 'rba':
        case 'json':
          msg = message;
          loadData(message);
          break;
      }
    });

    // init viewer when ready
    window.addEventListener('DOMContentLoaded', async function () {
      console.log('DOM Content is loaded');
      saveFileTypeSelector = document.getElementById('save-file-type-selector');
      viewer = document.getElementsByTagName('perspective-viewer')[0];
      viewer.toggleConfig();
      try {
        // request first data update
        vscode.postMessage({ cmd: 'ready', timezoneOffset: new Date().getTimezoneOffset() });
        isReady = true;
        loadData(msg);
      }
      catch (error) {
        console.error(`sending msg failed - error: ${error.message}`);
      }
    });

    // update rows and columns
    function updateStats() {
      const numberOfRows = viewer.view ? viewer.view.num_rows() : viewer.table.size();
      // get rows count and displayed columns info
      numberOfRows.then(rowCount => {
        const colCount = viewer['columns'].length;
        // notify webview for data stats status update
        document.getElementById('data-view-stats').value = `Row ${rowCount}, Col ${colCount}`;
      });
    }

    // load data to table(required for offline) and to viewer
    function loadData(msg) {
      if (isReady && msg) {
        try {
          var table;
          switch (msg.type) {
            case 'rba':
              table = worker.table(Uint8Array.from(msg.data).buffer);
              break;
            case 'json':
              table = worker.table(msg.meta);
              table.update(msg.data);
              break;
          }

          viewer.load(table)
            .then(_ => {
              viewer.reset();
              updateStats();
              const datagrid = viewer.querySelector('regular-table');
              for (const th of datagrid.querySelectorAll('th')) {
                const metadata = datagrid.getMeta(th);
                if (msg.keys.includes(metadata.value)) {
                  th.style.background = keyColor;
                }
              }
              datagrid.draw();
            });

        } catch (error) {
          console.error(`loadData - error: ${error.message}`);
        }
      }
    }

    // save data
    function saveData() {
      const dataFileType = saveFileTypeSelector.value;
      switch (dataFileType) {
        case '.csv':
          viewer.view.to_csv().then(csv => sendDataToVscode(csv, dataFileType));
          break;
        case '.xlsx':
          viewer.view.to_json({ date_format: 'en-US' }).then(json => sendDataToVscode(json, dataFileType));
          break;
      }
    }


    function sendDataToVscode(data, filetype) {
      vscode.postMessage({
        cmd: 'saveData',
        data: data,
        fileType: filetype
      });
    }

// function buyCoffee() {
//     vscode.postMessage({
//         command: 'buyCoffee',
//         viewName: 'vscode.open',
//         uri: 'https://www.buymeacoffee.com/jshinonome'
//     });
// }
  </script>
</body>

</html>